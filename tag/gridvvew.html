<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8" />
        <title>Singuloid Research（泰一奇点研究院） - GridvVew</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Singuloid Research（泰一奇点研究院） </a></h1>
                <nav><ul>
                    <li><a href="/pages/gong-zuo-ji-hui.html">工作机会</a></li>
                    <li><a href="/category/algorithm.html">Algorithm</a></li>
                    <li><a href="/category/android.html">Android</a></li>
                    <li><a href="/category/ios.html">iOS</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/gao-fang-pin-dao-guan-li-lei-si-wang-yi-jin-ri-tou-tiao-teng-xun-shi-pin.html">高仿频道管理----类似网易、今日头条、腾讯视频</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-05-05T08:42:00">
                一 05 五月 2014
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="/author/jianyan-zhu.html">Jianyan Zhu</a>
        </address>
<p>In <a href="/category/android.html">Android</a>. </p>
<p>tags: <a href="/tag/android.html">android</a><a href="/tag/ui.html">UI</a><a href="/tag/gridvvew.html">GridvVew</a></p>
</footer><!-- /.post-info --><p>这次实现的功能是很多新闻阅读器（网易，今日头条，360新闻等）以及腾讯视频等里面都会出现的频道管理功能。</p>
<p>下面先上这次实现功能的效果图：</p>
<blockquote>
<p>(注：这个效果图没有拖拽的时候移动动画，DEMO里面有，可以下载看看)
<img alt="" src="/images/draggable-gridview1.gif" /></p>
</blockquote>
<h1>一、开发心里历程</h1>
<p>刚开始接触这个的时候，不知道要如何实现，去网上翻了一大堆资料，懂了个大概，就是目前可以找到的都是拖拽的时候，不带移动动画的，和线上的客户端交互效果相差甚远，在反反复复的尝试查看相关东西，大致的做了出来，目前在模拟器上似乎有一点小BUG，真机测试没有问题，就先放上来，如果发现问题在修改优化。代码反面，没有好好的修改调整，可能会有点乱，请见谅哈。</p>
<h1>二、开发前的准备</h1>
<ol>
<li>
<p>了解重写View的相关知识，并且知道GridView的一些内部方法，如：怎么通过触摸的坐标获取对应的position等（这里我采用的是继承GridView控件）；</p>
</li>
<li>
<p>了解屏幕触摸动作传递原理    这里我以前转载的一篇或许会有帮助：Android事件分发机制完全解析，带你从源码的角度彻底理解(全)；</p>
</li>
<li>
<p>了解位移动画Animation，本DEMO中主要用到：TranslateAnimation  平移动画；</p>
</li>
<li>
<p>了解WindowManager的窗口机制，这里的item拖拽等都要设计到这个；</p>
</li>
<li>
<p>了解SQLiteDatabase 以及SQLiteOpenHelper等数据库操作相关的类，本DEMO中主要用到数据库进行存储频道信息，如果你要用文档进行存储读取也可以。</p>
</li>
</ol>
<h1>三、开发思路</h1>
<ol>
<li>
<p>获取数据库中频道的列表，如果为空，赋予默认列表，并存入数据库，之后通过对应的适配器赋给对应的GridView；</p>
</li>
<li>
<p>2个GridView--（1.DragGrid   2. OtherGridView）；</p>
</li>
</ol>
<p>DragGrid 用于显示我的频道，带有长按拖拽效果。</p>
<p>OtherGridView用于显示更多频道，不带推拽效果。</p>
<blockquote>
<p>注：由于屏幕大小不一定，外层使用ScrollView，所以2者都要重写计算高度；</p>
</blockquote>
<ol>
<li>
<p>点击2个GridView的时候，根据点击的Item对应的position，获取position对应的view，进行创建一层移动的动画层
起始位置：点击的positiongetLocationInWindow（）获取。终点位置：另一个GridView的最后个ITEM 的position + 1的位置。
并赋予移动动画，等动画结束后对2者对应的频道列表进行数据的remove和add操作；</p>
</li>
<li>
<p>设置点击和拖动的限制条件，如  推荐  这个ITEM是不允许用户操作的；</p>
</li>
<li>
<p>拖动的DragGrid的操作：</p>
<blockquote>
<ul>
<li>长按获取长按的ITEM的position  -- dragPosition 以及对应的view ，手指触摸屏幕的时候，调用onInterceptTouchEvent来获取MotionEvent.ACTION_DOWN事件，获取对应的数据。由于这里是继承了GridView，所以长按时间可以通过setOnItemLongClickListener监听来执行，或则你也可以通过计算点击时间来监听是否长按。</li>
</ul>
</blockquote>
</li>
</ol>
<blockquote>
<ul>
<li>
<p>通过onTouchEvent(MotionEvent ev)来监听手指的移动和抬起动作。当它移动到 其它的item下面，并且下方的item对应的position  不等于 dragPosition，进行数据交换，并且2者之间的所有item进行移动动画，动画结束后，数据更替刷新界面。</p>
</li>
<li>
<p>抬起手后，清除掉拖动时候创建的view，让GridView中的数据显示。</p>
</li>
</ul>
</blockquote>
<ol>
<li>退出时候，将改变后的频道列表存入数据库。</li>
</ol>
<p>四、流程图
下面是大体的流程图：</p>
<p><img alt="" src="/images/draggable-gridview2.jpg" /></p>
<p>五、核心代码</p>
<div class="highlight"><pre><span class="cm">/** GRIDVIEW对应的ITEM点击监听接口  */</span>  
<span class="nd">@Override</span>  
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onItemClick</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="kd">final</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>  
    <span class="c1">//如果点击的时候，之前动画还没结束，那么就让点击事件无效  </span>
    <span class="k">if</span><span class="o">(</span><span class="n">isMove</span><span class="o">){</span>  
        <span class="k">return</span><span class="o">;</span>  
    <span class="o">}</span>  
    <span class="k">switch</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>  
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">userGridView</span><span class="o">:</span>  
        <span class="c1">//position为 0，1 的不可以进行任何操作  </span>
        <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">position</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>  
            <span class="kd">final</span> <span class="n">ImageView</span> <span class="n">moveImageView</span> <span class="o">=</span> <span class="n">getView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>  
            <span class="k">if</span> <span class="o">(</span><span class="n">moveImageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">TextView</span> <span class="n">newTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text_item</span><span class="o">);</span>  
                <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">startLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>  
                <span class="n">newTextView</span><span class="o">.</span><span class="na">getLocationInWindow</span><span class="o">(</span><span class="n">startLocation</span><span class="o">);</span>  
                <span class="kd">final</span> <span class="n">ChannelItem</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">((</span><span class="n">DragAdapter</span><span class="o">)</span> <span class="n">parent</span><span class="o">.</span><span class="na">getAdapter</span><span class="o">()).</span><span class="na">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span><span class="c1">//获取点击的频道内容  </span>
                <span class="n">otherAdapter</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
                <span class="c1">//添加到最后一个  </span>
                <span class="n">otherAdapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>  
                <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>  
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  
                        <span class="k">try</span> <span class="o">{</span>  
                            <span class="kt">int</span><span class="o">[]</span> <span class="n">endLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>  
                            <span class="c1">//获取终点的坐标  </span>
                            <span class="n">otherGridView</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">otherGridView</span><span class="o">.</span><span class="na">getLastVisiblePosition</span><span class="o">()).</span><span class="na">getLocationInWindow</span><span class="o">(</span><span class="n">endLocation</span><span class="o">);</span>  
                            <span class="n">MoveAnim</span><span class="o">(</span><span class="n">moveImageView</span><span class="o">,</span> <span class="n">startLocation</span> <span class="o">,</span> <span class="n">endLocation</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span><span class="n">userGridView</span><span class="o">);</span>  
                            <span class="n">userAdapter</span><span class="o">.</span><span class="na">setRemove</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>  
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">localException</span><span class="o">)</span> <span class="o">{</span>  
                        <span class="o">}</span>  
                    <span class="o">}</span>  
                <span class="o">},</span> <span class="mi">50L</span><span class="o">);</span>  
            <span class="o">}</span>  
        <span class="o">}</span>  
        <span class="k">break</span><span class="o">;</span>  
    <span class="k">case</span> <span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">otherGridView</span><span class="o">:</span>  
        <span class="kd">final</span> <span class="n">ImageView</span> <span class="n">moveImageView</span> <span class="o">=</span> <span class="n">getView</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">moveImageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>  
            <span class="n">TextView</span> <span class="n">newTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">view</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text_item</span><span class="o">);</span>  
            <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">startLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>  
            <span class="n">newTextView</span><span class="o">.</span><span class="na">getLocationInWindow</span><span class="o">(</span><span class="n">startLocation</span><span class="o">);</span>  
            <span class="kd">final</span> <span class="n">ChannelItem</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">((</span><span class="n">OtherAdapter</span><span class="o">)</span> <span class="n">parent</span><span class="o">.</span><span class="na">getAdapter</span><span class="o">()).</span><span class="na">getItem</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>  
            <span class="n">userAdapter</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
            <span class="c1">//添加到最后一个  </span>
            <span class="n">userAdapter</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>  
            <span class="k">new</span> <span class="nf">Handler</span><span class="o">().</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>  
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  
                    <span class="k">try</span> <span class="o">{</span>  
                        <span class="kt">int</span><span class="o">[]</span> <span class="n">endLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>  
                        <span class="c1">//获取终点的坐标  </span>
                        <span class="n">userGridView</span><span class="o">.</span><span class="na">getChildAt</span><span class="o">(</span><span class="n">userGridView</span><span class="o">.</span><span class="na">getLastVisiblePosition</span><span class="o">()).</span><span class="na">getLocationInWindow</span><span class="o">(</span><span class="n">endLocation</span><span class="o">);</span>  
                        <span class="n">MoveAnim</span><span class="o">(</span><span class="n">moveImageView</span><span class="o">,</span> <span class="n">startLocation</span> <span class="o">,</span> <span class="n">endLocation</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span><span class="n">otherGridView</span><span class="o">);</span>  
                        <span class="n">otherAdapter</span><span class="o">.</span><span class="na">setRemove</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>  
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">localException</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="o">}</span>  
                <span class="o">}</span>  
            <span class="o">},</span> <span class="mi">50L</span><span class="o">);</span>  
        <span class="o">}</span>  
        <span class="k">break</span><span class="o">;</span>  
    <span class="k">default</span><span class="o">:</span>  
        <span class="k">break</span><span class="o">;</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></div>


<p>移动动画：</p>
<div class="highlight"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">MoveAnim</span><span class="o">(</span><span class="n">View</span> <span class="n">moveView</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">startLocation</span><span class="o">,</span><span class="kt">int</span><span class="o">[]</span> <span class="n">endLocation</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelItem</span> <span class="n">moveChannel</span><span class="o">,</span>  
            <span class="kd">final</span> <span class="n">GridView</span> <span class="n">clickGridView</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kt">int</span><span class="o">[]</span> <span class="n">initLocation</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>  
        <span class="c1">//获取传递过来的VIEW的坐标  </span>
        <span class="n">moveView</span><span class="o">.</span><span class="na">getLocationInWindow</span><span class="o">(</span><span class="n">initLocation</span><span class="o">);</span>  
        <span class="c1">//得到要移动的VIEW,并放入对应的容器中  </span>
        <span class="kd">final</span> <span class="n">ViewGroup</span> <span class="n">moveViewGroup</span> <span class="o">=</span> <span class="n">getMoveViewGroup</span><span class="o">();</span>  
        <span class="kd">final</span> <span class="n">View</span> <span class="n">mMoveView</span> <span class="o">=</span> <span class="n">getMoveView</span><span class="o">(</span><span class="n">moveViewGroup</span><span class="o">,</span> <span class="n">moveView</span><span class="o">,</span> <span class="n">initLocation</span><span class="o">);</span>  
        <span class="c1">//创建移动动画  </span>
        <span class="n">TranslateAnimation</span> <span class="n">moveAnimation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TranslateAnimation</span><span class="o">(</span>  
                <span class="n">startLocation</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">endLocation</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">startLocation</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span>  
                <span class="n">endLocation</span><span class="o">[</span><span class="mi">1</span><span class="o">]);</span>  
        <span class="n">moveAnimation</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="mi">300L</span><span class="o">);</span><span class="c1">//动画时间  </span>
        <span class="c1">//动画配置  </span>
        <span class="n">AnimationSet</span> <span class="n">moveAnimationSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnimationSet</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
        <span class="n">moveAnimationSet</span><span class="o">.</span><span class="na">setFillAfter</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span><span class="c1">//动画效果执行完毕后，View对象不保留在终止的位置  </span>
        <span class="n">moveAnimationSet</span><span class="o">.</span><span class="na">addAnimation</span><span class="o">(</span><span class="n">moveAnimation</span><span class="o">);</span>  
        <span class="n">mMoveView</span><span class="o">.</span><span class="na">startAnimation</span><span class="o">(</span><span class="n">moveAnimationSet</span><span class="o">);</span>  
        <span class="n">moveAnimationSet</span><span class="o">.</span><span class="na">setAnimationListener</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimationListener</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>  
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationStart</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">isMove</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  
            <span class="o">}</span>

            <span class="nd">@Override</span>  
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationRepeat</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
            <span class="o">}</span>

            <span class="nd">@Override</span>  
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">moveViewGroup</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">mMoveView</span><span class="o">);</span>  
                <span class="c1">// instanceof 方法判断2边实例是不是一样，判断点击的是DragGrid还是OtherGridView  </span>
                <span class="k">if</span> <span class="o">(</span><span class="n">clickGridView</span> <span class="k">instanceof</span> <span class="n">DragGrid</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="n">otherAdapter</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
                    <span class="n">otherAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>  
                    <span class="n">userAdapter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>  
                <span class="o">}</span><span class="k">else</span><span class="o">{</span>  
                    <span class="n">userAdapter</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
                    <span class="n">userAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>  
                    <span class="n">otherAdapter</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>  
                <span class="o">}</span>  
                <span class="n">isMove</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>  
            <span class="o">}</span>  
        <span class="o">});</span>  
    <span class="o">}</span>
</pre></div>


<p>可拖拽的DragGrid代码： </p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DragGrid</span> <span class="kd">extends</span> <span class="n">GridView</span> <span class="o">{</span>  
    <span class="cm">/** 点击时候的X位置 */</span>  
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">downX</span><span class="o">;</span>  
    <span class="cm">/** 点击时候的Y位置 */</span>  
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">downY</span><span class="o">;</span>  
    <span class="cm">/** 点击时候对应整个界面的X位置 */</span>  
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">windowX</span><span class="o">;</span>  
    <span class="cm">/** 点击时候对应整个界面的Y位置 */</span>  
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">windowY</span><span class="o">;</span>  
    <span class="cm">/** 屏幕上的X */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">win_view_x</span><span class="o">;</span>  
    <span class="cm">/** 屏幕上的Y */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">win_view_y</span><span class="o">;</span>  
    <span class="cm">/** 拖动的里x的距离 */</span>  
    <span class="kt">int</span> <span class="n">dragOffsetX</span><span class="o">;</span>  
    <span class="cm">/** 拖动的里Y的距离 */</span>  
    <span class="kt">int</span> <span class="n">dragOffsetY</span><span class="o">;</span>  
    <span class="cm">/** 长按时候对应postion */</span>  
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">dragPosition</span><span class="o">;</span>  
    <span class="cm">/** Up后对应的ITEM的Position */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dropPosition</span><span class="o">;</span>  
    <span class="cm">/** 开始拖动的ITEM的Position */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">startPosition</span><span class="o">;</span>  
    <span class="cm">/** item高 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">itemHeight</span><span class="o">;</span>  
    <span class="cm">/** item宽 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">itemWidth</span><span class="o">;</span>  
    <span class="cm">/** 拖动的时候对应ITEM的VIEW */</span>  
    <span class="kd">private</span> <span class="n">View</span> <span class="n">dragImageView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
    <span class="cm">/** 长按的时候ITEM的VIEW */</span>  
    <span class="kd">private</span> <span class="n">ViewGroup</span> <span class="n">dragItemView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
    <span class="cm">/** WindowManager管理器 */</span>  
    <span class="kd">private</span> <span class="n">WindowManager</span> <span class="n">windowManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
    <span class="cm">/** */</span>  
    <span class="kd">private</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span> <span class="n">windowParams</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
    <span class="cm">/** item总量 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">itemTotalCount</span><span class="o">;</span>  
    <span class="cm">/** 一行的ITEM数量 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">nColumns</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span>  
    <span class="cm">/** 行数 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">nRows</span><span class="o">;</span>  
    <span class="cm">/** 剩余部分 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">Remainder</span><span class="o">;</span>  
    <span class="cm">/** 是否在移动 */</span>  
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isMoving</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>  
    <span class="cm">/** */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">holdPosition</span><span class="o">;</span>  
    <span class="cm">/** 拖动的时候放大的倍数 */</span>  
    <span class="kd">private</span> <span class="kt">double</span> <span class="n">dragScale</span> <span class="o">=</span> <span class="mf">1.2</span><span class="n">D</span><span class="o">;</span>  
    <span class="cm">/** 震动器 */</span>  
    <span class="kd">private</span> <span class="n">Vibrator</span> <span class="n">mVibrator</span><span class="o">;</span>  
    <span class="cm">/** 每个ITEM之间的水平间距 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mHorizontalSpacing</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>  
    <span class="cm">/** 每个ITEM之间的竖直间距 */</span>  
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">mVerticalSpacing</span> <span class="o">=</span> <span class="mi">15</span><span class="o">;</span>  
    <span class="cm">/* 移动时候最后个动画的ID */</span>  
    <span class="kd">private</span> <span class="n">String</span> <span class="n">LastAnimationID</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DragGrid</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>  
        <span class="n">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">DragGrid</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">,</span> <span class="kt">int</span> <span class="n">defStyle</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">defStyle</span><span class="o">);</span>  
        <span class="n">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">DragGrid</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">AttributeSet</span> <span class="n">attrs</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">attrs</span><span class="o">);</span>  
        <span class="n">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">mVibrator</span> <span class="o">=</span> <span class="o">(</span><span class="n">Vibrator</span><span class="o">)</span> <span class="n">context</span>  
                <span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">VIBRATOR_SERVICE</span><span class="o">);</span>  
        <span class="c1">// 将布局文件中设置的间距dip转为px  </span>
        <span class="n">mHorizontalSpacing</span> <span class="o">=</span> <span class="n">DataTools</span><span class="o">.</span><span class="na">dip2px</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">mHorizontalSpacing</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onInterceptTouchEvent</span><span class="o">(</span><span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// TODO Auto-generated method stub  </span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">getAction</span><span class="o">()</span> <span class="o">==</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">downX</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span>  
            <span class="n">downY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>  
            <span class="n">windowX</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span>  
            <span class="n">windowY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>  
            <span class="n">setOnItemClickListener</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  
        <span class="o">}</span>  
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onInterceptTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTouchEvent</span><span class="o">(</span><span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// TODO Auto-generated method stub  </span>
        <span class="kt">boolean</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">dragImageView</span> <span class="o">!=</span> <span class="kc">null</span>  
                <span class="o">&amp;&amp;</span> <span class="n">dragPosition</span> <span class="o">!=</span> <span class="n">AdapterView</span><span class="o">.</span><span class="na">INVALID_POSITION</span><span class="o">)</span> <span class="o">{</span>  
            <span class="c1">// 移动时候的对应x,y位置  </span>
            <span class="n">bool</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span>  
            <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>  
            <span class="k">switch</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">getAction</span><span class="o">())</span> <span class="o">{</span>  
            <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">:</span>  
                <span class="n">downX</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span>  
                <span class="n">windowX</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span>  
                <span class="n">downY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>  
                <span class="n">windowY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span>  
                <span class="k">break</span><span class="o">;</span>  
            <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_MOVE</span><span class="o">:</span>  
                <span class="n">onDrag</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getRawX</span><span class="o">(),</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getRawY</span><span class="o">());</span>  
                <span class="k">if</span> <span class="o">(!</span><span class="n">isMoving</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="n">OnMove</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>  
                <span class="o">}</span>  
                <span class="k">if</span> <span class="o">(</span><span class="n">pointToPosition</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">!=</span> <span class="n">AdapterView</span><span class="o">.</span><span class="na">INVALID_POSITION</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="k">break</span><span class="o">;</span>  
                <span class="o">}</span>  
                <span class="k">break</span><span class="o">;</span>  
            <span class="k">case</span> <span class="n">MotionEvent</span><span class="o">.</span><span class="na">ACTION_UP</span><span class="o">:</span>  
                <span class="n">stopDrag</span><span class="o">();</span>  
                <span class="n">onDrop</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>  
                <span class="n">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
                <span class="k">break</span><span class="o">;</span>

            <span class="k">default</span><span class="o">:</span>  
                <span class="k">break</span><span class="o">;</span>  
            <span class="o">}</span>  
        <span class="o">}</span>  
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">onTouchEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="cm">/** 在拖动的情况 */</span>  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onDrag</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rawx</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rawy</span><span class="o">)</span> <span class="o">{</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">dragImageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">windowParams</span><span class="o">.</span><span class="na">alpha</span> <span class="o">=</span> <span class="mf">0.6f</span><span class="o">;</span>  
            <span class="n">windowParams</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="n">rawx</span> <span class="o">-</span> <span class="n">win_view_x</span><span class="o">;</span>  
            <span class="n">windowParams</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="n">rawy</span> <span class="o">-</span> <span class="n">win_view_y</span><span class="o">;</span>  
            <span class="n">windowManager</span><span class="o">.</span><span class="na">updateViewLayout</span><span class="o">(</span><span class="n">dragImageView</span><span class="o">,</span> <span class="n">windowParams</span><span class="o">);</span>  
        <span class="o">}</span>  
    <span class="o">}</span>

    <span class="cm">/** 在松手下放的情况 */</span>  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">onDrop</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// 根据拖动到的x,y坐标获取拖动位置下方的ITEM对应的POSTION  </span>
        <span class="kt">int</span> <span class="n">tempPostion</span> <span class="o">=</span> <span class="n">pointToPosition</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>  
        <span class="n">dropPosition</span> <span class="o">=</span> <span class="n">tempPostion</span><span class="o">;</span>  
        <span class="n">DragAdapter</span> <span class="n">mDragAdapter</span> <span class="o">=</span> <span class="o">(</span><span class="n">DragAdapter</span><span class="o">)</span> <span class="n">getAdapter</span><span class="o">();</span>  
        <span class="c1">// 显示刚拖动的ITEM  </span>
        <span class="n">mDragAdapter</span><span class="o">.</span><span class="na">setShowDropItem</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
        <span class="c1">// 刷新适配器，让对应的ITEM显示  </span>
        <span class="n">mDragAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>  
    <span class="o">}</span>

    <span class="cm">/** </span>
<span class="cm">     * 长按点击监听 </span>
<span class="cm">     * @param ev </span>
<span class="cm">     */</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOnItemClickListener</span><span class="o">(</span><span class="kd">final</span> <span class="n">MotionEvent</span> <span class="n">ev</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">setOnItemLongClickListener</span><span class="o">(</span><span class="k">new</span> <span class="n">OnItemLongClickListener</span><span class="o">()</span> <span class="o">{</span>

            <span class="nd">@Override</span>  
            <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onItemLongClick</span><span class="o">(</span><span class="n">AdapterView</span><span class="o">&lt;?&gt;</span> <span class="n">parent</span><span class="o">,</span> <span class="n">View</span> <span class="n">view</span><span class="o">,</span>  
                    <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>  
                <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getX</span><span class="o">();</span><span class="c1">// 长安事件的X位置  </span>
                <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getY</span><span class="o">();</span><span class="c1">// 长安事件的y位置  </span>
                <span class="n">startPosition</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span><span class="c1">// 第一次点击的postion  </span>
                <span class="n">dragPosition</span> <span class="o">=</span> <span class="n">position</span><span class="o">;</span>  
                <span class="k">if</span> <span class="o">(</span><span class="n">startPosition</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  
                <span class="o">}</span>  
                <span class="n">ViewGroup</span> <span class="n">dragViewGroup</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">dragPosition</span>  
                        <span class="o">-</span> <span class="n">getFirstVisiblePosition</span><span class="o">());</span>  
                <span class="n">TextView</span> <span class="n">dragTextView</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextView</span><span class="o">)</span> <span class="n">dragViewGroup</span>  
                        <span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">text_item</span><span class="o">);</span>  
                <span class="n">dragTextView</span><span class="o">.</span><span class="na">setSelected</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
                <span class="n">dragTextView</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
                <span class="n">itemHeight</span> <span class="o">=</span> <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>  
                <span class="n">itemWidth</span> <span class="o">=</span> <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">getWidth</span><span class="o">();</span>  
                <span class="n">itemTotalCount</span> <span class="o">=</span> <span class="n">DragGrid</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span>  
                <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">itemTotalCount</span> <span class="o">/</span> <span class="n">nColumns</span><span class="o">;</span><span class="c1">// 算出行数  </span>
                <span class="n">Remainder</span> <span class="o">=</span> <span class="o">(</span><span class="n">itemTotalCount</span> <span class="o">%</span> <span class="n">nColumns</span><span class="o">);</span><span class="c1">// 算出最后一行多余的数量  </span>
                <span class="k">if</span> <span class="o">(</span><span class="n">Remainder</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="n">nRows</span> <span class="o">=</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>  
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
                    <span class="n">nRows</span> <span class="o">=</span> <span class="n">row</span><span class="o">;</span>  
                <span class="o">}</span>  
                <span class="c1">// 如果特殊的这个不等于拖动的那个,并且不等于-1  </span>
                <span class="k">if</span> <span class="o">(</span><span class="n">dragPosition</span> <span class="o">!=</span> <span class="n">AdapterView</span><span class="o">.</span><span class="na">INVALID_POSITION</span><span class="o">)</span> <span class="o">{</span>  
                    <span class="c1">// 释放的资源使用的绘图缓存。如果你调用buildDrawingCache()手动没有调用setDrawingCacheEnabled(真正的),你应该清理缓存使用这种方法。  </span>
                    <span class="n">win_view_x</span> <span class="o">=</span> <span class="n">windowX</span> <span class="o">-</span> <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">getLeft</span><span class="o">();</span><span class="c1">// VIEW相对自己的X，半斤  </span>
                    <span class="n">win_view_y</span> <span class="o">=</span> <span class="n">windowY</span> <span class="o">-</span> <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">getTop</span><span class="o">();</span><span class="c1">// VIEW相对自己的y，半斤  </span>
                    <span class="n">dragOffsetX</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">getRawX</span><span class="o">()</span> <span class="o">-</span> <span class="n">x</span><span class="o">);</span><span class="c1">// 手指在屏幕的上X位置-手指在控件中的位置就是距离最左边的距离  </span>
                    <span class="n">dragOffsetY</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">getRawY</span><span class="o">()</span> <span class="o">-</span> <span class="n">y</span><span class="o">);</span><span class="c1">// 手指在屏幕的上y位置-手指在控件中的位置就是距离最上边的距离  </span>
                    <span class="n">dragItemView</span> <span class="o">=</span> <span class="n">dragViewGroup</span><span class="o">;</span>  
                    <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">destroyDrawingCache</span><span class="o">();</span>  
                    <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">setDrawingCacheEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
                    <span class="n">Bitmap</span> <span class="n">dragBitmap</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">dragViewGroup</span>  
                            <span class="o">.</span><span class="na">getDrawingCache</span><span class="o">());</span>  
                    <span class="n">mVibrator</span><span class="o">.</span><span class="na">vibrate</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span><span class="c1">// 设置震动时间  </span>
                    <span class="n">startDrag</span><span class="o">(</span><span class="n">dragBitmap</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getRawX</span><span class="o">(),</span>  
                            <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">ev</span><span class="o">.</span><span class="na">getRawY</span><span class="o">());</span>  
                    <span class="n">hideDropItem</span><span class="o">();</span>  
                    <span class="n">dragViewGroup</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>  
                    <span class="n">isMoving</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>  
                    <span class="n">requestDisallowInterceptTouchEvent</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>  
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>  
                <span class="o">}</span>  
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  
            <span class="o">}</span>  
        <span class="o">});</span>  
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startDrag</span><span class="o">(</span><span class="n">Bitmap</span> <span class="n">dragBitmap</span><span class="o">,</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">stopDrag</span><span class="o">();</span>  
        <span class="n">windowParams</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">();</span><span class="c1">// 获取WINDOW界面的  </span>
        <span class="c1">// Gravity.TOP|Gravity.LEFT;这个必须加  </span>
        <span class="n">windowParams</span><span class="o">.</span><span class="na">gravity</span> <span class="o">=</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">TOP</span> <span class="o">|</span> <span class="n">Gravity</span><span class="o">.</span><span class="na">LEFT</span><span class="o">;</span>  
        <span class="c1">// 得到preview左上角相对于屏幕的坐标  </span>
        <span class="n">windowParams</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">win_view_x</span><span class="o">;</span>  
        <span class="n">windowParams</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">win_view_y</span><span class="o">;</span>  
        <span class="c1">// 设置拖拽item的宽和高  </span>
        <span class="n">windowParams</span><span class="o">.</span><span class="na">width</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">dragScale</span> <span class="o">*</span> <span class="n">dragBitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">());</span><span class="c1">// 放大dragScale倍，可以设置拖动后的倍数  </span>
        <span class="n">windowParams</span><span class="o">.</span><span class="na">height</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">dragScale</span> <span class="o">*</span> <span class="n">dragBitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">());</span><span class="c1">// 放大dragScale倍，可以设置拖动后的倍数  </span>
        <span class="k">this</span><span class="o">.</span><span class="na">windowParams</span><span class="o">.</span><span class="na">flags</span> <span class="o">=</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_FOCUSABLE</span>  
                <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_NOT_TOUCHABLE</span>  
                <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_KEEP_SCREEN_ON</span>  
                <span class="o">|</span> <span class="n">WindowManager</span><span class="o">.</span><span class="na">LayoutParams</span><span class="o">.</span><span class="na">FLAG_LAYOUT_IN_SCREEN</span><span class="o">;</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">windowParams</span><span class="o">.</span><span class="na">format</span> <span class="o">=</span> <span class="n">PixelFormat</span><span class="o">.</span><span class="na">TRANSLUCENT</span><span class="o">;</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">windowParams</span><span class="o">.</span><span class="na">windowAnimations</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
        <span class="n">ImageView</span> <span class="n">iv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ImageView</span><span class="o">(</span><span class="n">getContext</span><span class="o">());</span>  
        <span class="n">iv</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">dragBitmap</span><span class="o">);</span>  
        <span class="n">windowManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">WindowManager</span><span class="o">)</span> <span class="n">getContext</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span>  
                <span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">);</span><span class="c1">// &quot;window&quot;  </span>
        <span class="n">windowManager</span><span class="o">.</span><span class="na">addView</span><span class="o">(</span><span class="n">iv</span><span class="o">,</span> <span class="n">windowParams</span><span class="o">);</span>  
        <span class="n">dragImageView</span> <span class="o">=</span> <span class="n">iv</span><span class="o">;</span>  
    <span class="o">}</span>

    <span class="cm">/** 停止拖动 ，释放并初始化 */</span>  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">stopDrag</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">if</span> <span class="o">(</span><span class="n">dragImageView</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">windowManager</span><span class="o">.</span><span class="na">removeView</span><span class="o">(</span><span class="n">dragImageView</span><span class="o">);</span>  
            <span class="n">dragImageView</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
        <span class="o">}</span>  
    <span class="o">}</span>

    <span class="cm">/** 在ScrollView内，所以要进行计算高度 */</span>  
    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMeasure</span><span class="o">(</span><span class="kt">int</span> <span class="n">widthMeasureSpec</span><span class="o">,</span> <span class="kt">int</span> <span class="n">heightMeasureSpec</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kt">int</span> <span class="n">expandSpec</span> <span class="o">=</span> <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">makeMeasureSpec</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="o">,</span>  
                <span class="n">MeasureSpec</span><span class="o">.</span><span class="na">AT_MOST</span><span class="o">);</span>  
        <span class="kd">super</span><span class="o">.</span><span class="na">onMeasure</span><span class="o">(</span><span class="n">widthMeasureSpec</span><span class="o">,</span> <span class="n">expandSpec</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="cm">/** 隐藏 放下 的ITEM */</span>  
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">hideDropItem</span><span class="o">()</span> <span class="o">{</span>  
        <span class="o">((</span><span class="n">DragAdapter</span><span class="o">)</span> <span class="n">getAdapter</span><span class="o">()).</span><span class="na">setShowDropItem</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="cm">/** 获取移动动画 */</span>  
    <span class="kd">public</span> <span class="n">Animation</span> <span class="nf">getMoveAnimation</span><span class="o">(</span><span class="kt">float</span> <span class="n">toXValue</span><span class="o">,</span> <span class="kt">float</span> <span class="n">toYValue</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">TranslateAnimation</span> <span class="n">mTranslateAnimation</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TranslateAnimation</span><span class="o">(</span>  
                <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span> <span class="mf">0.0</span><span class="n">F</span><span class="o">,</span> <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span>  
                <span class="n">toXValue</span><span class="o">,</span> <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span> <span class="mf">0.0</span><span class="n">F</span><span class="o">,</span>  
                <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span> <span class="n">toYValue</span><span class="o">);</span><span class="c1">// 当前位置移动到指定位置  </span>
        <span class="n">mTranslateAnimation</span><span class="o">.</span><span class="na">setFillAfter</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span><span class="c1">// 设置一个动画效果执行完毕后，View对象保留在终止的位置。  </span>
        <span class="n">mTranslateAnimation</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="mi">300L</span><span class="o">);</span>  
        <span class="k">return</span> <span class="n">mTranslateAnimation</span><span class="o">;</span>  
    <span class="o">}</span>

    <span class="cm">/** 移动的时候触发 */</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">OnMove</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// 拖动的VIEW下方的POSTION  </span>
        <span class="kt">int</span> <span class="n">dPosition</span> <span class="o">=</span> <span class="n">pointToPosition</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">);</span>  
        <span class="c1">// 判断下方的POSTION是否是最开始2个不能拖动的  </span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dPosition</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>  
            <span class="k">if</span> <span class="o">((</span><span class="n">dPosition</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">dPosition</span> <span class="o">==</span> <span class="n">dragPosition</span><span class="o">))</span> <span class="o">{</span>  
                <span class="k">return</span><span class="o">;</span>  
            <span class="o">}</span>  
            <span class="n">dropPosition</span> <span class="o">=</span> <span class="n">dPosition</span><span class="o">;</span>  
            <span class="k">if</span> <span class="o">(</span><span class="n">dragPosition</span> <span class="o">!=</span> <span class="n">startPosition</span><span class="o">)</span> <span class="o">{</span>  
                <span class="n">dragPosition</span> <span class="o">=</span> <span class="n">startPosition</span><span class="o">;</span>  
            <span class="o">}</span>  
            <span class="kt">int</span> <span class="n">movecount</span><span class="o">;</span>  
            <span class="c1">// 拖动的=开始拖的，并且 拖动的 不等于放下的  </span>
            <span class="k">if</span> <span class="o">((</span><span class="n">dragPosition</span> <span class="o">==</span> <span class="n">startPosition</span><span class="o">)</span>  
                    <span class="o">||</span> <span class="o">(</span><span class="n">dragPosition</span> <span class="o">!=</span> <span class="n">dropPosition</span><span class="o">))</span> <span class="o">{</span>  
                <span class="c1">// 移需要移动的动ITEM数量  </span>
                <span class="n">movecount</span> <span class="o">=</span> <span class="n">dropPosition</span> <span class="o">-</span> <span class="n">dragPosition</span><span class="o">;</span>  
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
                <span class="c1">// 移需要移动的动ITEM数量为0  </span>
                <span class="n">movecount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
            <span class="o">}</span>  
            <span class="k">if</span> <span class="o">(</span><span class="n">movecount</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
                <span class="k">return</span><span class="o">;</span>  
            <span class="o">}</span>

            <span class="kt">int</span> <span class="n">movecount_abs</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">movecount</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">dPosition</span> <span class="o">!=</span> <span class="n">dragPosition</span><span class="o">)</span> <span class="o">{</span>  
                <span class="c1">// dragGroup设置为不可见  </span>
                <span class="n">ViewGroup</span> <span class="n">dragGroup</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">dragPosition</span><span class="o">);</span>  
                <span class="n">dragGroup</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">View</span><span class="o">.</span><span class="na">INVISIBLE</span><span class="o">);</span>  
                <span class="kt">float</span> <span class="n">to_x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span><span class="c1">// 当前下方positon  </span>
                <span class="kt">float</span> <span class="n">to_y</span><span class="o">;</span><span class="c1">// 当前下方右边positon  </span>
                <span class="c1">// x_vlaue移动的距离百分比（相对于自己长度的百分比）  </span>
                <span class="kt">float</span> <span class="n">x_vlaue</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">mHorizontalSpacing</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">itemWidth</span><span class="o">)</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="o">;</span>  
                <span class="c1">// y_vlaue移动的距离百分比（相对于自己宽度的百分比）  </span>
                <span class="kt">float</span> <span class="n">y_vlaue</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span> <span class="n">mVerticalSpacing</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">itemHeight</span><span class="o">)</span> <span class="o">+</span> <span class="mf">1.0f</span><span class="o">;</span>  
                <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="s">&quot;x_vlaue&quot;</span><span class="o">,</span> <span class="s">&quot;x_vlaue = &quot;</span> <span class="o">+</span> <span class="n">x_vlaue</span><span class="o">);</span>  
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">movecount_abs</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>  
                    <span class="n">to_x</span> <span class="o">=</span> <span class="n">x_vlaue</span><span class="o">;</span>  
                    <span class="n">to_y</span> <span class="o">=</span> <span class="n">y_vlaue</span><span class="o">;</span>  
                    <span class="c1">// 像左  </span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">movecount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
                        <span class="c1">// 判断是不是同一行的  </span>
                        <span class="n">holdPosition</span> <span class="o">=</span> <span class="n">dragPosition</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>  
                        <span class="k">if</span> <span class="o">(</span><span class="n">dragPosition</span> <span class="o">/</span> <span class="n">nColumns</span> <span class="o">==</span> <span class="n">holdPosition</span> <span class="o">/</span> <span class="n">nColumns</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">holdPosition</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y_vlaue</span><span class="o">;</span>  
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
                        <span class="o">}</span>  
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
                        <span class="c1">// 向右,下移到上，右移到左  </span>
                        <span class="n">holdPosition</span> <span class="o">=</span> <span class="n">dragPosition</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>  
                        <span class="k">if</span> <span class="o">(</span><span class="n">dragPosition</span> <span class="o">/</span> <span class="n">nColumns</span> <span class="o">==</span> <span class="n">holdPosition</span> <span class="o">/</span> <span class="n">nColumns</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">((</span><span class="n">holdPosition</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="n">y_vlaue</span><span class="o">;</span>  
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
                            <span class="n">to_x</span> <span class="o">=</span> <span class="n">x_vlaue</span><span class="o">;</span>  
                            <span class="n">to_y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>  
                        <span class="o">}</span>  
                    <span class="o">}</span>  
                    <span class="n">ViewGroup</span> <span class="n">moveViewGroup</span> <span class="o">=</span> <span class="o">(</span><span class="n">ViewGroup</span><span class="o">)</span> <span class="n">getChildAt</span><span class="o">(</span><span class="n">holdPosition</span><span class="o">);</span>  
                    <span class="n">Animation</span> <span class="n">moveAnimation</span> <span class="o">=</span> <span class="n">getMoveAnimation</span><span class="o">(</span><span class="n">to_x</span><span class="o">,</span> <span class="n">to_y</span><span class="o">);</span>  
                    <span class="n">moveViewGroup</span><span class="o">.</span><span class="na">startAnimation</span><span class="o">(</span><span class="n">moveAnimation</span><span class="o">);</span>  
                    <span class="c1">// 如果是最后一个移动的，那么设置他的最后个动画ID为LastAnimationID  </span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">holdPosition</span> <span class="o">==</span> <span class="n">dropPosition</span><span class="o">)</span> <span class="o">{</span>  
                        <span class="n">LastAnimationID</span> <span class="o">=</span> <span class="n">moveAnimation</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>  
                    <span class="o">}</span>  
                    <span class="n">moveAnimation</span><span class="o">.</span><span class="na">setAnimationListener</span><span class="o">(</span><span class="k">new</span> <span class="n">AnimationListener</span><span class="o">()</span> <span class="o">{</span>

                        <span class="nd">@Override</span>  
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationStart</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="c1">// TODO Auto-generated method stub  </span>
                            <span class="n">isMoving</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  
                        <span class="o">}</span>

                        <span class="nd">@Override</span>  
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationRepeat</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="c1">// TODO Auto-generated method stub</span>

                        <span class="o">}</span>

                        <span class="nd">@Override</span>  
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAnimationEnd</span><span class="o">(</span><span class="n">Animation</span> <span class="n">animation</span><span class="o">)</span> <span class="o">{</span>  
                            <span class="c1">// TODO Auto-generated method stub  </span>
                            <span class="c1">// 如果为最后个动画结束，那执行下面的方法  </span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">animation</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equalsIgnoreCase</span><span class="o">(</span>  
                                    <span class="n">LastAnimationID</span><span class="o">))</span> <span class="o">{</span>  
                                <span class="n">DragAdapter</span> <span class="n">mDragAdapter</span> <span class="o">=</span> <span class="o">(</span><span class="n">DragAdapter</span><span class="o">)</span> <span class="n">getAdapter</span><span class="o">();</span>  
                                <span class="n">mDragAdapter</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="n">startPosition</span><span class="o">,</span>  
                                        <span class="n">dropPosition</span><span class="o">);</span>  
                                <span class="n">startPosition</span> <span class="o">=</span> <span class="n">dropPosition</span><span class="o">;</span>  
                                <span class="n">dragPosition</span> <span class="o">=</span> <span class="n">dropPosition</span><span class="o">;</span>  
                                <span class="n">isMoving</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>  
                            <span class="o">}</span>  
                        <span class="o">}</span>  
                    <span class="o">});</span>  
                <span class="o">}</span>  
            <span class="o">}</span>  
        <span class="o">}</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></div>


<p>数据库SQLHelper文件：</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SQLHelper</span> <span class="kd">extends</span> <span class="n">SQLiteOpenHelper</span> <span class="o">{</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">DB_NAME</span> <span class="o">=</span> <span class="s">&quot;database.db&quot;</span><span class="o">;</span><span class="c1">// 数据库名称  </span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">VERSION</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_CHANNEL</span> <span class="o">=</span> <span class="s">&quot;channel&quot;</span><span class="o">;</span><span class="c1">//数据表</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ID</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="o">;</span><span class="c1">//  </span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">NAME</span> <span class="o">=</span> <span class="s">&quot;name&quot;</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ORDERID</span> <span class="o">=</span> <span class="s">&quot;orderId&quot;</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SELECTED</span> <span class="o">=</span> <span class="s">&quot;selected&quot;</span><span class="o">;</span>  
    <span class="kd">private</span> <span class="n">Context</span> <span class="n">context</span><span class="o">;</span>  
    <span class="kd">public</span> <span class="nf">SQLHelper</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>  
        <span class="kd">super</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">DB_NAME</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">VERSION</span><span class="o">);</span>  
        <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>  
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Context</span> <span class="nf">getContext</span><span class="o">(){</span>  
        <span class="k">return</span> <span class="n">context</span><span class="o">;</span>  
    <span class="o">}</span>

    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// TODO 创建数据库后，对数据库的操作  </span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;create table if not exists &quot;</span><span class="o">+</span><span class="n">TABLE_CHANNEL</span> <span class="o">+</span>  
                <span class="s">&quot;(_id INTEGER PRIMARY KEY AUTOINCREMENT, &quot;</span> <span class="o">+</span>  
                <span class="n">ID</span> <span class="o">+</span> <span class="s">&quot; INTEGER , &quot;</span> <span class="o">+</span>  
                <span class="n">NAME</span> <span class="o">+</span> <span class="s">&quot; TEXT , &quot;</span> <span class="o">+</span>  
                <span class="n">ORDERID</span> <span class="o">+</span> <span class="s">&quot; INTEGER , &quot;</span> <span class="o">+</span>  
                <span class="n">SELECTED</span> <span class="o">+</span> <span class="s">&quot; SELECTED)&quot;</span><span class="o">;</span>  
        <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>  
    <span class="o">}</span>

    <span class="nd">@Override</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="n">SQLiteDatabase</span> <span class="n">db</span><span class="o">,</span> <span class="kt">int</span> <span class="n">oldVersion</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newVersion</span><span class="o">)</span> <span class="o">{</span>  
        <span class="c1">// TODO 更改数据库版本的操作  </span>
        <span class="n">onCreate</span><span class="o">(</span><span class="n">db</span><span class="o">);</span>  
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<p>注：本DEMO中，加入了长按震动，所以在权限里面记得加上“</p>
<div class="highlight"><pre><span class="c">&lt;!-- 在SDCard中创建与删除文件权限 --&gt;</span>  
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;</span> <span class="nt">/&gt;</span>  
<span class="c">&lt;!-- 往SDCard写入数据权限 --&gt;</span>  
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;</span> <span class="nt">/&gt;</span>  
<span class="c">&lt;!-- 震动权限 --&gt;</span>  
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.VIBRATE&quot;</span><span class="nt">/&gt;</span>
</pre></div>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://www.singuloid.com/">泰一奇点</a></li>
                            <li><a href="http://www.adtime.com/">AdTime</a></li>
                        </ul>
                </div><!-- /.blogroll -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>